#include <pwd.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#ifndef FLAG
#  error "We need a FLAG to set as the user!"
#endif

int
main(int argc, char **argv)
{
  struct passwd passwdEntry;
  struct passwd *passwdEntryResult;
  long passwdBufferLength = sysconf(_SC_GETPW_R_SIZE_MAX);
  char *passwdBuffer = (char*) malloc(sizeof(char) * passwdBufferLength);

#define X(x) __STRING(x)
  /* search the user database for a name */
  if(getpwnam_r(X(FLAG), &passwdEntry, passwdBuffer, passwdBufferLength, &passwdEntryResult) != 0
      && &passwdEntry != passwdEntryResult) /* did we succeed? */
    { perror("getpwnam_r(3)"); return 1; }
#undef X

  /* set the real, effective and saved uid and gid *
   * this will be the id's of the flagXX users     */
  if(setreuid(passwdEntry.pw_uid, passwdEntry.pw_uid) != 0)
    { perror("setreuid(3)"); return 1; }

  /* we definately don't need this anymore */
  free(passwdBuffer);

  /* do we wish to delete this application? */
  if(argc == 2 && strncmp("-d", argv[1], 3) == 0) {
    if(unlink(argv[0]) != 0) /* then delete it */
      { perror("unlink(3)"); return 2; }
    return 0;
  }

  /* run bash as uid:gid user */
  system("/bin/bash");

  return 0;
}
